<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard ‚Äî SMM CMS</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
      .dash {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 24px;
      }
      .dash .row {
        display: grid;
        gap: 8px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .row-inline {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      textarea.json {
        min-height: 360px;
        font-family: ui-monospace, Consolas, monospace;
      }
      .help {
        color: var(--muted);
        font-size: 12px;
      }
    </style>
    <script type="module" src="assets/js/i18n.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Dashboard ‚Äî M…ôzmun idar…ôetm…ôsi</h1>
      <div class="dash">
        <div class="card">
          <div class="row-inline">
            <button id="btn-ru" class="btn">RU</button>
            <button id="btn-az" class="btn">AZ</button>
            <span class="help"
              >Cari dil etiketl…ôr…ô v…ô m…ôtnl…ôr…ô t…ôsir edir.</span
            >
          </div>
        </div>

        <div class="card">
          <h3>S√ºr…ôtli redakt…ô: Brend v…ô Hero</h3>
          <div class="row">
            <label>Loqo (≈ü…ôkil)</label>
            <input id="brandLogoFile" type="file" accept="image/*" />
            <img
              id="brandLogoPreview"
              alt="logo preview"
              style="
                width: 56px;
                height: 56px;
                object-fit: cover;
                border-radius: 10px;
                border: 1px solid var(--line);
                display: none;
              "
            />
            <span class="help"
              >Loqo yadda saxlanacaq v…ô header-d…ô d…ôrhal yenil…ôn…ôc…ôk.</span
            >
          </div>
          <div class="grid-2">
            <div class="row">
              <label>Brend adƒ±</label>
              <input id="brandInput" placeholder="Alievs Space SMM" />
              <span class="help">Header-d…ô g√∂st…ôrilir.</span>
            </div>
            <div class="row">
              <label>Hero Ba≈ülƒ±q (RU / AZ)</label>
              <input
                id="heroTitleRu"
                placeholder="Tam d√∂vriyy…ôli SMM agentliyi"
              />
              <input
                id="heroTitleAz"
                placeholder="Tam d√∂vriyy…ôli SMM agentliyi"
              />
            </div>
            <div class="row">
              <label>Hero Alt ba≈ülƒ±q (RU / AZ)</label>
              <input
                id="heroSubRu"
                placeholder="Dizayn, kreativlik, strategiya v…ô artƒ±m ‚Äî hamƒ±sƒ± bir yerd…ô."
              />
              <input
                id="heroSubAz"
                placeholder="Dizayn, kreativlik, strategiya v…ô artƒ±m ‚Äî hamƒ±sƒ± bir yerd…ô."
              />
            </div>
          </div>
          <div class="row-inline">
            <button id="save-hero" class="btn">Yadda saxla</button>
          </div>
        </div>

        <div class="card">
          <h3>Footer</h3>
          <div class="row">
            <label>Footer qeyd (RU)</label>
            <textarea
              id="footerNoteRu"
              placeholder="¬© 2025 Spark Agency MMC. B√ºt√ºn h√ºquqlar qorunur."
            ></textarea>
          </div>
          <div class="row">
            <label>Footer qeyd (AZ)</label>
            <textarea
              id="footerNoteAz"
              placeholder="¬© 2025 Spark Agency MMC. B√ºt√ºn h√ºquqlar qorunur."
            ></textarea>
          </div>
          <div class="row-inline">
            <button id="saveFooterNote" class="btn">
              Footer m…ôtnini yadda saxla
            </button>
          </div>
          <hr class="sep" />
          <h4>Sosial linkl…ôr</h4>
          <div id="footerSocialList" class="list"></div>
          <div class="row-inline">
            <input
              id="footerSocialIcon"
              placeholder="instagram"
              style="width: 140px"
            />
            <input
              id="footerSocialUrl"
              placeholder="https://instagram.com/spark"
              style="min-width: 320px"
            />
            <button id="addFooterSocial" class="btn">Link …ôlav…ô et</button>
          </div>
          <span class="help"
            >ƒ∞kon adlarƒ± `assets/js/headerFooter.js` faylƒ±ndakƒ± `icon` funksiyasƒ±
            il…ô uyƒüun olmalƒ±dƒ±r.</span
          >
        </div>

        <div class="card">
          <h3>Qalereya (≈ü…ôkill…ôr v…ô videolar)</h3>
          <div id="galleryList" class="list"></div>
          <div class="row-inline">
            <select id="galleryType">
              <option value="image">image</option>
              <option value="video">video</option>
            </select>

            <input id="galleryFile" type="file" accept="image/*,video/*" />

            <input
              id="gallerySrc"
              placeholder="Faylƒ±n URL-i (jpg/png/mp4)"
              style="min-width: 320px"
            />
            <input id="galleryAlt" placeholder="Alt/t…ôsvir" />
            <button id="addGallery" class="btn">∆èlav…ô et</button>
          </div>
          <span class="help"
            >Fayllar Data URL kimi saxlanƒ±lƒ±r. D…ôst…ôk: ≈ü…ôkill…ôr (jpg/png/webp)
            v…ô videolar (mp4).</span
          >
        </div>

        <div class="card">
          <h3>Servisl…ôr</h3>
          <div id="servicesList" class="list"></div>

          <div class="row-inline">
            <div class="row-inline">
              <!-- <input
                id="svcIcon"
                placeholder="ƒ∞kon (emoji), m…ôs…ôl…ôn üé®"
                style="width: 120px"
              /> -->
              <input id="svcTitleRu" placeholder="Ba≈ülƒ±q (RU)" />
              <input id="svcTitleAz" placeholder="Ba≈ülƒ±q (AZ)" />
            </div>
            <div class="row-inline">
              <input
                id="svcDescRu"
                placeholder="T…ôsvir (RU)"
                style="min-width: 360px"
              />
              <input
                id="svcDescAz"
                placeholder="T…ôsvir (AZ)"
                style="min-width: 360px"
              />
              <input id="svcIconFile" type="file" accept="image/*" />
              <button id="addService" class="btn">Servis …ôlav…ô et</button>
            </div>

            <span class="help"
              >Servisl…ôr ¬´∆èsas¬ª v…ô ¬´Xidm…ôtl…ôr¬ª s…ôhif…ôl…ôrind…ô g√∂st…ôrilir.</span
            >
          </div>
        </div>

        <div class="card">
          <h3>Haqqƒ±mƒ±zda</h3>

          <!-- HERO -->
          <div class="row">
            <label>Hero ‚Äî Ba≈ülƒ±q (RU / AZ)</label>
            <input
              id="aboutHeroTitleRu"
              placeholder="Haqqƒ±mƒ±zda ‚Äî kreativlik & artƒ±m"
            />
            <input
              id="aboutHeroTitleAz"
              placeholder="Haqqƒ±mƒ±zda ‚Äî kreativlik & artƒ±m"
            />
          </div>
          <div class="row">
            <label>Hero ‚Äî Alt ba≈ülƒ±q (RU / AZ)</label>
            <input
              id="aboutHeroSubRu"
              placeholder="Strategiya, dizayn v…ô performansƒ± birl…ô≈üdiririk."
            />
            <input
              id="aboutHeroSubAz"
              placeholder="Strategiya, dizayn v…ô performansƒ± birl…ô≈üdiririk."
            />
          </div>
          <div class="row-inline">
            <label>Hero ‚Äî Banner (≈ü…ôkil)</label>
            <input id="aboutHeroImg" type="file" accept="image/*" />
            <img
              id="aboutHeroPreview"
              alt="hero"
              style="
                width: 120px;
                height: 64px;
                object-fit: cover;
                border-radius: 10px;
                border: 1px solid var(--line);
                display: none;
              "
            />
            <button id="aboutHeroSave" class="btn">Hero-nu yadda saxla</button>
          </div>
          <hr class="sep" />

          <!-- STATS -->
          <h4>Statistika (KPI)</h4>
          <div id="aboutStatsList" class="list"></div>
          <div class="row-inline">
            <input id="statLabelRu" placeholder="T…ôcr√ºb…ô ayƒ± (RU)" />
            <input id="statLabelAz" placeholder="T…ôcr√ºb…ô ayƒ± (AZ)" />
            <input id="statValue" placeholder="12" />
            <button id="addStat" class="btn">KPI …ôlav…ô et</button>
          </div>
          <hr class="sep" />

          <!-- VALUES -->
          <h4>D…ôy…ôrl…ôr</h4>
          <div id="aboutValuesList" class="list"></div>
          <div class="row-inline">
            <input
              id="valRu"
              placeholder="M√º≈üt…ôriy…ô fokus (RU)"
              style="min-width: 360px"
            />
            <input
              id="valAz"
              placeholder="M√º≈üt…ôriy…ô fokus (AZ)"
              style="min-width: 360px"
            />
            <button id="addValue" class="btn">D…ôy…ôr …ôlav…ô et</button>
          </div>
          <hr class="sep" />

          <!-- TIMELINE -->
          <h4>Zaman x…ôtti</h4>
          <div id="aboutTimelineList" class="list"></div>
          <div class="row-inline">
            <input id="tlYear" placeholder="2023" style="width: 120px" />
            <input
              id="tlTextRu"
              placeholder="Agentliyi a√ßdƒ±q (RU)"
              style="min-width: 320px"
            />
            <input
              id="tlTextAz"
              placeholder="Agentliyi a√ßdƒ±q (AZ)"
              style="min-width: 320px"
            />
            <button id="addTimeline" class="btn">Hadis…ô …ôlav…ô et</button>
          </div>
          <hr class="sep" />

          <!-- TEAM -->
          <h4>Komanda</h4>
          <div id="aboutTeamList" class="list"></div>
          <div class="row-inline">
            <input id="teamName" placeholder="Ad" />
            <input id="teamRoleRu" placeholder="Rol (RU)" />
            <input id="teamRoleAz" placeholder="Rol (AZ)" />
            <input id="teamAvatar" type="file" accept="image/*" />
            <button id="addTeam" class="btn">√úzv …ôlav…ô et</button>
          </div>
          <span class="help"
            >B√ºt√ºn t…ôsvirl…ôr Data URL kimi saxlanƒ±lƒ±r.</span
          >
        </div>

        <div class="card">
          <h3>Paketl…ôr</h3>
          <div id="packagesList" class="list"></div>
          <div class="row-inline">
            <input id="pkgNameRu" placeholder="Ad (RU)" />
            <input id="pkgNameAz" placeholder="Ad (AZ)" />
            <input id="pkgPrice" type="number" placeholder="Qiym…ôt" />
            <input id="pkgCurrency" placeholder="Valyuta (USD/AZN)" />
            <input id="pkgFeaturesRu" placeholder="Funksiyalar RU ; il…ô" />
            <input id="pkgFeaturesAz" placeholder="Funksiyalar AZ ; il…ô" />
            <button id="addPkg" class="btn">Paket …ôlav…ô et</button>
          </div>
        </div>

        <div class="card">
          <h3>FAQ</h3>
          <div id="faqList" class="list"></div>
          <div class="row-inline">
            <input id="faqQRu" placeholder="Sual RU" />
            <input id="faqQAz" placeholder="Sual AZ" />
            <input
              id="faqARu"
              placeholder="Cavab RU"
              style="min-width: 320px"
            />
            <input
              id="faqAAz"
              placeholder="Cavab AZ"
              style="min-width: 320px"
            />
            <button id="addFaq" class="btn">FAQ …ôlav…ô et</button>
          </div>
        </div>

        <div class="card">
          <h3>Tam JSON (eksport/idxal)</h3>
          <textarea id="jsonArea" class="json"></textarea>
          <div class="row-inline">
            <button id="exportBtn" class="btn">Eksport</button>
            <button id="importBtn" class="btn">ƒ∞dxal</button>
            <span class="help">ƒ∞dxal hazƒ±rkƒ± m…ôzmunu tam …ôv…ôz ed…ôc…ôk.</span>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        getContent,
        updateContent,
        setLocale,
      } from "./assets/js/i18n.js";
      import {
        syncAllFromAPI,
        ServicesAPI,
        PackagesAPI,
        FaqAPI,
        SiteAPI,
        GalleryAPI,
        AboutAPI,
      } from "./assets/js/apiClient.js";

      /* ---------- Helpers ---------- */
      function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      function setAcceptByType(input, type) {
        if (!input) return;
        input.accept = type === "video" ? "video/*" : "image/*";
      }

      let syncing = false;

      function notifyError(message, error) {
        console.error(message, error);
        alert(message);
      }

      async function refreshAllData({ silent = false } = {}) {
        if (syncing) return;
        syncing = true;
        try {
          await syncAllFromAPI();
          if (!silent) console.info("–ö–æ–Ω—Ç–µ–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω –∏–∑ API");
        } catch (error) {
          if (!silent) notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞", error);
          else console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞", error);
        } finally {
          renderAllSections();
          syncing = false;
        }
      }

      function renderAllSections() {
        hydrateQuick();
        hydrateFooter();
        renderServicesAdmin();
        renderGalleryAdmin();
        renderPackagesAdmin();
        renderFaqAdmin();
        renderAboutAdmin();
      }
      function ensureAbout() {
        const c = getContent();
        if (!c.about) {
          updateContent((cc) => {
            cc.about = {
              hero: {
                title: {
                  ru: "–û –Ω–∞—Å ‚Äî –∫—Ä–µ–∞—Ç–∏–≤ & —Ä–æ—Å—Ç",
                  az: "Haqqƒ±mƒ±zda ‚Äî kreativlik & artƒ±m",
                },
                subtitle: {
                  ru: "–ú—ã —Å–æ–µ–¥–∏–Ω—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –¥–∏–∑–∞–π–Ω –∏ –ø–µ—Ä—Ñ–æ—Ä–º–∞–Ω—Å.",
                  az: "Strategiya, dizayn v…ô performansƒ± birl…ô≈üdiririk.",
                },
                imageSrc: "",
              },
              stats: [],
              values: [],
              timeline: [],
              team: [],
            };
          });
        }
      }

      /* ---------- FOOTER (note + socials) ---------- */
      function renderFooterSocialsAdmin() {
        const list = document.getElementById("footerSocialList");
        if (!list) return;
        const socials = getContent().site.socials || [];

        if (!socials.length) {
          list.innerHTML = "<span class=\"help\">H…ôl…ô link yoxdur.</span>";
          return;
        }

        list.innerHTML = socials
          .map(
            (s, idx) => `
      <div class="row-inline">
        <input value="${s.icon || ""}" data-idx="${idx}" data-field="icon" placeholder="instagram" style="width:140px">
        <input value="${s.url || ""}" data-idx="${idx}" data-field="url" placeholder="https://..." style="min-width:320px">
        <button data-idx="${idx}" data-act="del-footer-social" class="btn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `
          )
          .join("");

        list.querySelectorAll("input[data-field]").forEach((inp) => {
          inp.addEventListener("change", () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            const value = inp.value.trim();
            updateContent((c) => {
              if (!Array.isArray(c.site.socials)) c.site.socials = [];
              if (!c.site.socials[idx]) c.site.socials[idx] = { icon: "", url: "" };
              c.site.socials[idx][field] = value;
            });
          });
        });

        list
          .querySelectorAll('button[data-act="del-footer-social"]')
          .forEach((btn) => {
            btn.addEventListener("click", () => {
              const idx = +btn.dataset.idx;
              updateContent((c) => {
                if (!Array.isArray(c.site.socials)) return;
                c.site.socials.splice(idx, 1);
              });
              renderFooterSocialsAdmin();
            });
          });
      }

      function hydrateFooter() {
        const ru = document.getElementById("footerNoteRu");
        const az = document.getElementById("footerNoteAz");
        const c = getContent();
        if (ru) ru.value = c.locales?.ru?.footer_note || "";
        if (az) az.value = c.locales?.az?.footer_note || "";
        renderFooterSocialsAdmin();
      }

      /* ---------- SERVICES (CRUD + icon file) ---------- */
      function renderServicesAdmin() {
        const list = document.getElementById("servicesList");
        if (!list) return;
        const c = getContent();
        list.innerHTML = c.services
          .map(
            (s, idx) => `
      <div class="row-inline">
        ${
          s.iconSrc
            ? `<img src="${s.iconSrc}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">`
            : `<span class="badge">emoji</span>`
        }
        <input value="${
          s.icon || ""
        }" data-idx="${idx}" data-field="icon" style="width:100px" placeholder="—ç–º–æ–¥–∑–∏/—Å–∏–º–≤–æ–ª">
        <input type="file" data-idx="${idx}" data-act="svc-icon-file" accept="image/*">
      </div>
      <div class="row-inline" style="margin-top:-6px">
        <input value="${
          s.title?.ru || ""
        }" data-idx="${idx}" data-field="title.ru" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ RU">
        <input value="${
          s.title?.az || ""
        }" data-idx="${idx}" data-field="title.az" placeholder="Ba≈ülƒ±q AZ">
      </div>
      <div class="row-inline" style="margin-top:-6px">
        <input value="${
          s.desc?.ru || ""
        }" data-idx="${idx}" data-field="desc.ru" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ RU" style="min-width:360px">
        <input value="${
          s.desc?.az || ""
        }" data-idx="${idx}" data-field="desc.az" placeholder="T…ôsvir AZ" style="min-width:360px">
        <button data-idx="${idx}" data-act="del-svc" class="btn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <hr class="sep">
    `
          )
          .join("");

        list.querySelectorAll("input[data-field]").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              if (field === "icon") c.services[idx].icon = inp.value;
              else {
                const [grp, loc] = field.split(".");
                c.services[idx][grp][loc] = inp.value;
              }
            });
            try {
              await persistService(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list
          .querySelectorAll('input[type="file"][data-act="svc-icon-file"]')
          .forEach((fileInp) => {
            fileInp.addEventListener("change", async () => {
              const file = fileInp.files?.[0];
              if (!file) return;
              const idx = +fileInp.dataset.idx;
              const svc = getContent().services[idx];
              if (!svc?.id) {
                return notifyError(
                  "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ—Ä–≤–∏—Å, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∫–æ–Ω–∫—É",
                  ""
                );
              }
              try {
                const dataUrl = await readFileAsDataURL(file);
                updateContent((c) => {
                  c.services[idx].iconSrc = dataUrl;
                });
                renderServicesAdmin();
                await ServicesAPI.uploadIconBase64(svc.id, dataUrl);
                await refreshAllData({ silent: true });
              } catch (error) {
                notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∫–æ–Ω–∫—É", error);
                await refreshAllData({ silent: true });
              }
            });
          });

        list.querySelectorAll('button[data-act="del-svc"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const svc = getContent().services[idx];
            if (!svc?.id) {
              updateContent((c) => {
                c.services.splice(idx, 1);
              });
              renderServicesAdmin();
              return;
            }
            try {
              await ServicesAPI.delete(svc.id);
            } catch (error) {
              return notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å", error);
            }
            await refreshAllData();
          });
        });
      }

      function serviceToDto(service) {
        return {
          icon: service.icon || "",
          iconSrc: service.iconSrc || "",
          titleRu: service.title?.ru || "",
          titleAz: service.title?.az || "",
          descriptionRu: service.desc?.ru || "",
          descriptionAz: service.desc?.az || "",
        };
      }

      async function persistService(idx) {
        const svc = getContent().services[idx];
        if (!svc) return;
        const payload = serviceToDto(svc);
        if (svc.id) await ServicesAPI.update(svc.id, payload);
        else await ServicesAPI.create(payload);
      }

      /* ---------- GALLERY (file/URL + replace file) ---------- */
      function renderGalleryAdmin() {
        const list = document.getElementById("galleryList");
        if (!list) return;
        const c = getContent();
        list.innerHTML = c.gallery
          .map(
            (g, idx) => `
      <div class="row-inline">
        <span class="badge">${g.type}</span>
        ${
          g.type === "image"
            ? `<img src="${g.src}" alt="${
                g.alt || ""
              }" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">`
            : ""
        }
        ${
          g.type === "video"
            ? `<video src="${g.src}" style="width:100px;height:56px;object-fit:cover;border-radius:8px;border:1px solid var(--line)" muted></video>`
            : ""
        }
        <input value="${
          g.src
        }" data-idx="${idx}" data-field="src" style="min-width:360px">
        <input value="${g.alt || ""}" data-idx="${idx}" data-field="alt">
        <input type="file" data-idx="${idx}" data-act="replace-file">
        <button data-idx="${idx}" data-act="del" class="btn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `
          )
          .join("");

        list.querySelectorAll("input[data-field]").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              c.gallery[idx][field] = inp.value;
            });
            try {
              await upsertGalleryItem(idx);
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list.querySelectorAll('button[data-act="del"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const item = getContent().gallery[idx];
            if (!item?.id) {
              updateContent((c) => {
                c.gallery.splice(idx, 1);
              });
              renderGalleryAdmin();
              return;
            }
            try {
              await GalleryAPI.delete(item.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏", error);
            }
          });
        });

        list
          .querySelectorAll('input[type="file"][data-act="replace-file"]')
          .forEach((fileInp) => {
            const idx = +fileInp.dataset.idx;
            const g = getContent().gallery[idx];
            setAcceptByType(fileInp, g.type);
            fileInp.addEventListener("change", async () => {
              const file = fileInp.files?.[0];
              if (!file) return;
              try {
                await replaceGalleryFile(idx, file);
              } catch (error) {
                notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª –≥–∞–ª–µ—Ä–µ–∏", error);
                await refreshAllData({ silent: true });
              }
            });
          });
      }

      async function upsertGalleryItem(idx) {
        const item = getContent().gallery[idx];
        if (!item) return;
        const payload = {
          type: item.type,
          src: item.src,
          alt: item.alt,
        };
        if (!payload.src) return;
        if (item.id) {
          await GalleryAPI.create(payload);
          await GalleryAPI.delete(item.id);
        } else {
          await GalleryAPI.create(payload);
        }
        await refreshAllData({ silent: true });
      }

      async function replaceGalleryFile(idx, file) {
        const item = getContent().gallery[idx];
        if (!item) return;
        const isVideo = file.type.startsWith("video/") || item.type === "video";
        const alt = item.alt || "";
        if (isVideo) await GalleryAPI.uploadVideo(file, { alt });
        else await GalleryAPI.uploadImage(file, { alt });
        if (item.id) await GalleryAPI.delete(item.id);
        await refreshAllData({ silent: true });
      }

      /* ---------- PACKAGES ---------- */
      function renderPackagesAdmin() {
        const list = document.getElementById("packagesList");
        if (!list) return;
        const c = getContent();
        list.innerHTML = c.packages
          .map(
            (p, idx) => `
      <div class="row-inline">
        <input value="${
          p.name?.ru || ""
        }" data-idx="${idx}" data-field="name.ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ RU">
        <input value="${
          p.name?.az || ""
        }" data-idx="${idx}" data-field="name.az" placeholder="Ad AZ">
        <input type="number" value="${
          p.price
        }" data-idx="${idx}" data-field="price">
        <input value="${
          p.currency || ""
        }" data-idx="${idx}" data-field="currency">
      </div>
      <div class="row-inline" style="margin-top:-6px">
        <input value="${(p.features?.ru || []).join(
          "; "
        )}" data-idx="${idx}" data-field="features.ru" style="min-width:240px" placeholder="–§–∏—á–∏ RU —á–µ—Ä–µ–∑ ;">
        <input value="${(p.features?.az || []).join(
          "; "
        )}" data-idx="${idx}" data-field="features.az" style="min-width:240px" placeholder="Fitur AZ ; il…ô">
        <button data-idx="${idx}" data-act="del" class="btn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <hr class="sep">
    `
          )
          .join("");

        list.querySelectorAll("input[data-field]").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              if (field === "price") c.packages[idx].price = +inp.value;
              else if (field === "currency")
                c.packages[idx].currency = inp.value;
              else if (field === "name.ru") c.packages[idx].name.ru = inp.value;
              else if (field === "name.az") c.packages[idx].name.az = inp.value;
              else if (field === "features.ru")
                c.packages[idx].features.ru = inp.value
                  .split(";")
                  .map((s) => s.trim())
                  .filter(Boolean);
              else if (field === "features.az")
                c.packages[idx].features.az = inp.value
                  .split(";")
                  .map((s) => s.trim())
                  .filter(Boolean);
            });
            try {
              await persistPackage(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list.querySelectorAll('button[data-act="del"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const pkg = getContent().packages[idx];
            if (!pkg?.id) {
              updateContent((c) => {
                c.packages.splice(idx, 1);
              });
              renderPackagesAdmin();
              return;
            }
            try {
              await PackagesAPI.delete(pkg.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞–∫–µ—Ç", error);
            }
          });
        });
      }

      function packageToDto(pkg) {
        return {
          nameRu: pkg.name?.ru || "",
          nameAz: pkg.name?.az || "",
          price: pkg.price ?? 0,
          currency: pkg.currency || "",
          featuresRu: pkg.features?.ru || [],
          featuresAz: pkg.features?.az || [],
        };
      }

      async function persistPackage(idx) {
        const pkg = getContent().packages[idx];
        if (!pkg) return;
        const payload = packageToDto(pkg);
        if (pkg.id) await PackagesAPI.update(pkg.id, payload);
        else await PackagesAPI.create(payload);
      }

      /* ---------- FAQ ---------- */
      function renderFaqAdmin() {
        const list = document.getElementById("faqList");
        if (!list) return;
        const c = getContent();
        list.innerHTML = c.faq
          .map(
            (x, idx) => `
      <div class="row-inline">
        <input value="${
          x.q?.ru || ""
        }" data-idx="${idx}" data-field="q.ru" placeholder="–í–æ–ø—Ä–æ—Å RU">
        <input value="${
          x.q?.az || ""
        }" data-idx="${idx}" data-field="q.az" placeholder="Sual AZ">
      </div>
      <div class="row-inline" style="margin-top:-6px">
        <input value="${
          x.a?.ru || ""
        }" data-idx="${idx}" data-field="a.ru" placeholder="–û—Ç–≤–µ—Ç RU" style="min-width:320px">
        <input value="${
          x.a?.az || ""
        }" data-idx="${idx}" data-field="a.az" placeholder="Cavab AZ" style="min-width:320px">
        <button data-idx="${idx}" data-act="del" class="btn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
      <hr class="sep">
    `
          )
          .join("");

        list.querySelectorAll("input[data-field]").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              const [grp, loc] = field.split(".");
              c.faq[idx][grp][loc] = inp.value;
            });
            try {
              await persistFaq(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å FAQ", error);
              await refreshAllData({ silent: true });
            }
          });
        });
        list.querySelectorAll('button[data-act="del"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const item = getContent().faq[idx];
            if (!item?.id) {
              updateContent((c) => {
                c.faq.splice(idx, 1);
              });
              renderFaqAdmin();
              return;
            }
            try {
              await FaqAPI.delete(item.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å FAQ", error);
            }
          });
        });
      }

      function faqToDto(item) {
        return {
          questionRu: item.q?.ru || "",
          questionAz: item.q?.az || "",
          answerRu: item.a?.ru || "",
          answerAz: item.a?.az || "",
        };
      }

      async function persistFaq(idx) {
        const item = getContent().faq[idx];
        if (!item) return;
        const payload = faqToDto(item);
        if (item.id) await FaqAPI.update(item.id, payload);
        else await FaqAPI.create(payload);
      }

      /* ---------- Brand / Hero (+ logo) ---------- */
      async function handleBrandLogoSaveIfSelected() {
        const file = document.getElementById("brandLogoFile")?.files?.[0];
        if (!file) return false;
        try {
          await SiteAPI.uploadLogo(file);
          return true;
        } catch (error) {
          notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–æ—Ç–∏–ø", error);
          return false;
        }
      }

      function hydrateQuick() {
        const c = getContent();
        const bi = document.getElementById("brandInput");
        const hru = document.getElementById("heroTitleRu");
        const haz = document.getElementById("heroTitleAz");
        const sru = document.getElementById("heroSubRu");
        const saz = document.getElementById("heroSubAz");
        if (bi) bi.value = c.site.brand || "";
        if (hru) hru.value = c.locales?.ru?.hero_title || "";
        if (haz) haz.value = c.locales?.az?.hero_title || "";
        if (sru) sru.value = c.locales?.ru?.hero_subtitle || "";
        if (saz) saz.value = c.locales?.az?.hero_subtitle || "";

        const prev = document.getElementById("brandLogoPreview");
        if (prev) {
          const src = getContent().site.logoSrc;
          if (src) {
            prev.src = src;
            prev.style.display = "inline-block";
          } else {
            prev.style.display = "none";
          }
        }
      }

      function bindBrandHero() {
        document
          .getElementById("btn-ru")
          ?.addEventListener("click", () => setLocale("ru"));
        document
          .getElementById("btn-az")
          ?.addEventListener("click", () => setLocale("az"));

        const saveHeroBtn = document.getElementById("save-hero");
        if (saveHeroBtn) {
          saveHeroBtn.onclick = async () => {
            const brand = document.getElementById("brandInput").value;
            const hru = document.getElementById("heroTitleRu").value;
            const haz = document.getElementById("heroTitleAz").value;
            const sru = document.getElementById("heroSubRu").value;
            const saz = document.getElementById("heroSubAz").value;

            const payload = {
              brandName: brand,
              heroTitleRu: hru,
              heroTitleAz: haz,
              heroSubtitleRu: sru,
              heroSubtitleAz: saz,
            };
            const siteId = getContent().site?.id;
            try {
              if (siteId) {
                payload.id = siteId;
                await SiteAPI.update(payload);
              } else {
                await SiteAPI.create(payload);
              }
              const uploaded = await handleBrandLogoSaveIfSelected();
              if (uploaded) {
                const logoInput = document.getElementById("brandLogoFile");
                if (logoInput) logoInput.value = "";
              }
              await refreshAllData();
              alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ.");
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–∞–π—Ç–∞", error);
            }
          };
        }

        const logoFile = document.getElementById("brandLogoFile");
        const logoPrev = document.getElementById("brandLogoPreview");
        if (logoFile && logoPrev) {
          logoFile.addEventListener("change", async () => {
            const f = logoFile.files?.[0];
            if (!f) {
              logoPrev.style.display = "none";
              return;
            }
            const dataUrl = await readFileAsDataURL(f);
            logoPrev.src = dataUrl;
            logoPrev.style.display = "inline-block";
          });
        }
      }

      function bindFooterActions() {
        const saveFooter = document.getElementById("saveFooterNote");
        if (saveFooter) {
          saveFooter.onclick = () => {
            const ru = document.getElementById("footerNoteRu")?.value.trim() || "";
            const az = document.getElementById("footerNoteAz")?.value.trim() || "";
            updateContent((c) => {
              if (!c.locales.ru) c.locales.ru = {};
              if (!c.locales.az) c.locales.az = {};
              c.locales.ru.footer_note = ru;
              c.locales.az.footer_note = az;
            });
            alert("Footer m…ôtnl…ôri yadda saxlanƒ±ldƒ±.");
          };
        }

        const addSocial = document.getElementById("addFooterSocial");
        if (addSocial) {
          addSocial.onclick = () => {
            const icon = document.getElementById("footerSocialIcon")?.value.trim();
            const url = document.getElementById("footerSocialUrl")?.value.trim();
            if (!icon || !url) return alert("ƒ∞kon v…ô link daxil edin.");
            updateContent((c) => {
              (c.site.socials ||= []).push({ icon, url });
            });
            const iconInput = document.getElementById("footerSocialIcon");
            const urlInput = document.getElementById("footerSocialUrl");
            if (iconInput) iconInput.value = "";
            if (urlInput) urlInput.value = "";
            renderFooterSocialsAdmin();
          };
        }
      }

      /* ---------- Add New Service / Gallery entries ---------- */
      function bindCreateService() {
        const btn = document.getElementById("addService");
        if (!btn) return;
        btn.onclick = async () => {
          const icon = (document.getElementById("svcIcon")?.value || "").trim();
          const titleRu = (
            document.getElementById("svcTitleRu")?.value || ""
          ).trim();
          const titleAz = (
            document.getElementById("svcTitleAz")?.value || ""
          ).trim();
          const descRu = (
            document.getElementById("svcDescRu")?.value || ""
          ).trim();
          const descAz = (
            document.getElementById("svcDescAz")?.value || ""
          ).trim();
          const iconFile = document.getElementById("svcIconFile")?.files?.[0];
          if (!titleRu || !titleAz) return alert("–£–∫–∞–∂–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ RU –∏ AZ.");

          let iconSrc;
          if (iconFile) {
            try {
              iconSrc = await readFileAsDataURL(iconFile);
            } catch (e) {
              return alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª –∏–∫–æ–Ω–∫–∏: " + e.message);
            }
          }
          try {
            await ServicesAPI.create({
              icon: icon || "‚ú®",
              iconSrc,
              titleRu,
              titleAz,
              descriptionRu: descRu,
              descriptionAz: descAz,
            });
            [
              "svcIcon",
              "svcTitleRu",
              "svcTitleAz",
              "svcDescRu",
              "svcDescAz",
            ].forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.value = "";
            });
            if (document.getElementById("svcIconFile"))
              document.getElementById("svcIconFile").value = "";
            await refreshAllData();
            alert("–°–µ—Ä–≤–∏—Å –¥–æ–±–∞–≤–ª–µ–Ω");
          } catch (error) {
            notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å", error);
          }
        };
      }

      function bindCreateGallery() {
        const addGalBtn = document.getElementById("addGallery");
        if (!addGalBtn) return;
        addGalBtn.onclick = async () => {
          const type = document.getElementById("galleryType").value;
          const urlVal = document.getElementById("gallerySrc").value.trim();
          const alt = document.getElementById("galleryAlt").value.trim();
          const file = document.getElementById("galleryFile")?.files?.[0];

          try {
            if (file) {
              const isVideo = file.type.startsWith("video/");
              if (isVideo) await GalleryAPI.uploadVideo(file, { alt });
              else await GalleryAPI.uploadImage(file, { alt });
            } else {
              if (!urlVal) return alert("–£–∫–∞–∂–∏—Ç–µ URL –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª.");
              await GalleryAPI.create({ type, src: urlVal, alt });
            }
            if (document.getElementById("gallerySrc"))
              document.getElementById("gallerySrc").value = "";
            if (document.getElementById("galleryAlt"))
              document.getElementById("galleryAlt").value = "";
            if (document.getElementById("galleryFile"))
              document.getElementById("galleryFile").value = "";
            await refreshAllData();
            alert("–≠–ª–µ–º–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏ –¥–æ–±–∞–≤–ª–µ–Ω");
          } catch (error) {
            notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç –≥–∞–ª–µ—Ä–µ–∏", error);
          }
        };

        const typeSel = document.getElementById("galleryType");
        const fileInp = document.getElementById("galleryFile");
        if (typeSel && fileInp) {
          setAcceptByType(fileInp, typeSel.value);
          typeSel.addEventListener("change", () =>
            setAcceptByType(fileInp, typeSel.value)
          );
        }
      }

      function bindCreatePackage() {
        const btn = document.getElementById("addPkg");
        if (!btn) return;
        btn.onclick = async () => {
          const nameRu = document.getElementById("pkgNameRu")?.value.trim();
          const nameAz = document.getElementById("pkgNameAz")?.value.trim();
          const priceVal = document.getElementById("pkgPrice")?.value;
          const currency = document.getElementById("pkgCurrency")?.value.trim();
          const featuresRuRaw = document.getElementById("pkgFeaturesRu")?.value;
          const featuresAzRaw = document.getElementById("pkgFeaturesAz")?.value;

          if (!nameRu || !nameAz || !priceVal)
            return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É –ø–∞–∫–µ—Ç–∞");

          const payload = {
            nameRu,
            nameAz,
            price: Number(priceVal),
            currency,
            featuresRu: (featuresRuRaw || "")
              .split(";")
              .map((s) => s.trim())
              .filter(Boolean),
            featuresAz: (featuresAzRaw || "")
              .split(";")
              .map((s) => s.trim())
              .filter(Boolean),
          };

          try {
            await PackagesAPI.create(payload);
            [
              "pkgNameRu",
              "pkgNameAz",
              "pkgPrice",
              "pkgCurrency",
              "pkgFeaturesRu",
              "pkgFeaturesAz",
            ].forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.value = "";
            });
            await refreshAllData();
            alert("–ü–∞–∫–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω");
          } catch (error) {
            notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–∞–∫–µ—Ç", error);
          }
        };
      }

      function bindCreateFaq() {
        const btn = document.getElementById("addFaq");
        if (!btn) return;
        btn.onclick = async () => {
          const qRu = document.getElementById("faqQRu")?.value.trim();
          const qAz = document.getElementById("faqQAz")?.value.trim();
          const aRu = document.getElementById("faqARu")?.value.trim();
          const aAz = document.getElementById("faqAAz")?.value.trim();
          if (!qRu || !qAz || !aRu || !aAz)
            return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è FAQ");
          try {
            await FaqAPI.create({
              questionRu: qRu,
              questionAz: qAz,
              answerRu: aRu,
              answerAz: aAz,
            });
            ["faqQRu", "faqQAz", "faqARu", "faqAAz"].forEach((id) => {
              const el = document.getElementById(id);
              if (el) el.value = "";
            });
            await refreshAllData();
            alert("FAQ –¥–æ–±–∞–≤–ª–µ–Ω");
          } catch (error) {
            notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å FAQ", error);
          }
        };
      }

      /* ---------- ABOUT (Admin) ---------- */
      function hydrateAboutHero() {
        const c = getContent();
        const a = c.about || {};
        const titleRu = document.getElementById("aboutHeroTitleRu");
        const titleAz = document.getElementById("aboutHeroTitleAz");
        const subRu = document.getElementById("aboutHeroSubRu");
        const subAz = document.getElementById("aboutHeroSubAz");
        const prev = document.getElementById("aboutHeroPreview");
        if (titleRu) titleRu.value = a.hero?.title?.ru || "";
        if (titleAz) titleAz.value = a.hero?.title?.az || "";
        if (subRu) subRu.value = a.hero?.subtitle?.ru || "";
        if (subAz) subAz.value = a.hero?.subtitle?.az || "";
        if (prev) {
          if (a.hero?.imageSrc) {
            prev.src = a.hero.imageSrc;
            prev.style.display = "inline-block";
          } else prev.style.display = "none";
        }
      }

      function renderAboutStatsAdmin() {
        const list = document.getElementById("aboutStatsList");
        if (!list) return;
        const a = getContent().about || {};
        list.innerHTML = (a.stats || [])
          .map(
            (s, idx) => `
      <div class="row-inline">
        <input value="${
          s.label?.ru || ""
        }" data-idx="${idx}" data-field="label.ru" placeholder="–ú–µ—Ç–∫–∞ RU">
        <input value="${
          s.label?.az || ""
        }" data-idx="${idx}" data-field="label.az" placeholder="M…ôtn AZ">
        <input value="${
          s.value || ""
        }" data-idx="${idx}" data-field="value" style="width:120px" placeholder="–ó–Ω–∞—á.">
        <button class="btn" data-act="del-stat" data-idx="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `
          )
          .join("");

        list.querySelectorAll("input").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              if (field === "value") c.about.stats[idx].value = inp.value;
              else {
                const [grp, loc] = field.split(".");
                c.about.stats[idx][grp][loc] = inp.value;
              }
            });
            try {
              await persistAboutStat(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list.querySelectorAll('button[data-act="del-stat"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const stat = getContent().about?.stats?.[idx];
            if (!stat?.id) {
              updateContent((c) => {
                c.about.stats.splice(idx, 1);
              });
              renderAboutStatsAdmin();
              return;
            }
            try {
              await AboutAPI.deleteStat(stat.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É", error);
            }
          });
        });
      }

      function statToDto(stat) {
        return {
          labelRu: stat.label?.ru || "",
          labelAz: stat.label?.az || "",
          value: stat.value || "",
        };
      }

      async function persistAboutStat(idx) {
        const stat = getContent().about?.stats?.[idx];
        if (!stat) return;
        const payload = statToDto(stat);
        if (stat.id) await AboutAPI.updateStat(stat.id, payload);
        else await AboutAPI.createStat(payload);
      }

      function renderAboutValuesAdmin() {
        const list = document.getElementById("aboutValuesList");
        if (!list) return;
        const a = getContent().about || {};
        list.innerHTML = (a.values || [])
          .map(
            (v, idx) => `
      <div class="row-inline">
        <input value="${
          v.ru || ""
        }" data-idx="${idx}" data-field="ru" style="min-width:360px">
        <input value="${
          v.az || ""
        }" data-idx="${idx}" data-field="az" style="min-width:360px">
        <button class="btn" data-act="del-val" data-idx="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `
          )
          .join("");

        list.querySelectorAll("input").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              c.about.values[idx][field] = inp.value;
            });
            try {
              await persistAboutValue(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list.querySelectorAll('button[data-act="del-val"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const value = getContent().about?.values?.[idx];
            if (!value?.id) {
              updateContent((c) => {
                c.about.values.splice(idx, 1);
              });
              renderAboutValuesAdmin();
              return;
            }
            try {
              await AboutAPI.deleteValue(value.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å", error);
            }
          });
        });
      }

      function valueToDto(value) {
        return {
          valueRu: value.ru || "",
          valueAz: value.az || "",
        };
      }

      async function persistAboutValue(idx) {
        const value = getContent().about?.values?.[idx];
        if (!value) return;
        const payload = valueToDto(value);
        if (value.id) await AboutAPI.updateValue(value.id, payload);
        else await AboutAPI.createValue(payload);
      }

      function renderAboutTimelineAdmin() {
        const list = document.getElementById("aboutTimelineList");
        if (!list) return;
        const a = getContent().about || {};
        list.innerHTML = (a.timeline || [])
          .map(
            (t, idx) => `
      <div class="row-inline">
        <input value="${
          t.year || ""
        }" data-idx="${idx}" data-field="year" style="width:120px">
        <input value="${
          t.text?.ru || ""
        }" data-idx="${idx}" data-field="text.ru" style="min-width:320px">
        <input value="${
          t.text?.az || ""
        }" data-idx="${idx}" data-field="text.az" style="min-width:320px">
        <button class="btn" data-act="del-tl" data-idx="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `
          )
          .join("");

        list.querySelectorAll("input").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              if (field === "year") c.about.timeline[idx].year = inp.value;
              else {
                const [grp, loc] = field.split(".");
                c.about.timeline[idx][grp][loc] = inp.value;
              }
            });
            try {
              await persistAboutTimeline(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list.querySelectorAll('button[data-act="del-tl"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const tl = getContent().about?.timeline?.[idx];
            if (!tl?.id) {
              updateContent((c) => {
                c.about.timeline.splice(idx, 1);
              });
              renderAboutTimelineAdmin();
              return;
            }
            try {
              await AboutAPI.deleteTimeline(tl.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ", error);
            }
          });
        });
      }

      function timelineToDto(tl) {
        return {
          year: tl.year || "",
          textRu: tl.text?.ru || "",
          textAz: tl.text?.az || "",
        };
      }

      async function persistAboutTimeline(idx) {
        const tl = getContent().about?.timeline?.[idx];
        if (!tl) return;
        const payload = timelineToDto(tl);
        if (tl.id) await AboutAPI.updateTimeline(tl.id, payload);
        else await AboutAPI.createTimeline(payload);
      }

      function renderAboutTeamAdmin() {
        const list = document.getElementById("aboutTeamList");
        if (!list) return;
        const a = getContent().about || {};
        list.innerHTML = (a.team || [])
          .map(
            (m, idx) => `
      <div class="row-inline">
        ${
          m.avatarSrc
            ? `<img src="${m.avatarSrc}" style="width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">`
            : `<span class="badge">no photo</span>`
        }
        <input value="${
          m.name || ""
        }" data-idx="${idx}" data-field="name" placeholder="–ò–º—è">
        <input value="${
          m.role?.ru || ""
        }" data-idx="${idx}" data-field="role.ru" placeholder="–†–æ–ª—å RU">
        <input value="${
          m.role?.az || ""
        }" data-idx="${idx}" data-field="role.az" placeholder="Rol AZ">
        <input type="file" data-idx="${idx}" data-act="team-avatar" accept="image/*">
        <button class="btn" data-act="del-team" data-idx="${idx}">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `
          )
          .join("");

        list.querySelectorAll("input[data-field]").forEach((inp) => {
          inp.addEventListener("change", async () => {
            const idx = +inp.dataset.idx;
            const field = inp.dataset.field;
            updateContent((c) => {
              if (field === "name") c.about.team[idx].name = inp.value;
              else {
                const [grp, loc] = field.split(".");
                c.about.team[idx][grp][loc] = inp.value;
              }
            });
            try {
              await persistAboutTeamMember(idx);
              await refreshAllData({ silent: true });
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞", error);
              await refreshAllData({ silent: true });
            }
          });
        });

        list
          .querySelectorAll('input[type="file"][data-act="team-avatar"]')
          .forEach((fileInp) => {
            fileInp.addEventListener("change", async () => {
              const f = fileInp.files?.[0];
              if (!f) return;
              const idx = +fileInp.dataset.idx;
              const member = getContent().about?.team?.[idx];
              if (!member?.id)
                return notifyError(
                  "–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ",
                  ""
                );
              try {
                const dataUrl = await readFileAsDataURL(f);
                updateContent((c) => {
                  c.about.team[idx].avatarSrc = dataUrl;
                });
                renderAboutTeamAdmin();
                await AboutAPI.uploadTeamAvatar(member.id, dataUrl);
                await refreshAllData({ silent: true });
              } catch (error) {
                notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä", error);
                await refreshAllData({ silent: true });
              }
            });
          });

        list.querySelectorAll('button[data-act="del-team"]').forEach((btn) => {
          btn.addEventListener("click", async () => {
            const idx = +btn.dataset.idx;
            const member = getContent().about?.team?.[idx];
            if (!member?.id) {
              updateContent((c) => {
                c.about.team.splice(idx, 1);
              });
              renderAboutTeamAdmin();
              return;
            }
            try {
              await AboutAPI.deleteTeamMember(member.id);
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞", error);
            }
          });
        });
      }

      function teamToDto(member) {
        return {
          name: member.name || "",
          roleRu: member.role?.ru || "",
          roleAz: member.role?.az || "",
          avatarSrc: member.avatarSrc || "",
        };
      }

      async function persistAboutTeamMember(idx) {
        const member = getContent().about?.team?.[idx];
        if (!member) return;
        const payload = teamToDto(member);
        if (member.id) await AboutAPI.updateTeamMember(member.id, payload);
        else await AboutAPI.createTeamMember(payload);
      }

      function bindAboutActions() {
        const saveHero = document.getElementById("aboutHeroSave");
        if (saveHero) {
          saveHero.onclick = async () => {
            const ruT = document
              .getElementById("aboutHeroTitleRu")
              .value.trim();
            const azT = document
              .getElementById("aboutHeroTitleAz")
              .value.trim();
            const ruS = document.getElementById("aboutHeroSubRu").value.trim();
            const azS = document.getElementById("aboutHeroSubAz").value.trim();
            const f = document.getElementById("aboutHeroImg").files?.[0];

            try {
              await AboutAPI.updateHero({
                heroTitleRu: ruT,
                heroTitleAz: azT,
                heroSubtitleRu: ruS,
                heroSubtitleAz: azS,
                heroImageSrc: getContent().about?.hero?.imageSrc || "",
              });

              if (f) {
                const dataUrl = await readFileAsDataURL(f);
                await AboutAPI.uploadHeroImage(dataUrl);
                const fileInput = document.getElementById("aboutHeroImg");
                if (fileInput) fileInput.value = "";
              }

              await refreshAllData();
              const prev = document.getElementById("aboutHeroPreview");
              if (prev && getContent().about?.hero?.imageSrc) {
                prev.src = getContent().about.hero.imageSrc;
                prev.style.display = "inline-block";
              }
              alert("Hero —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–ª–æ–∫ Hero", error);
            }
          };
        }

        const addStat = document.getElementById("addStat");
        if (addStat) {
          addStat.onclick = async () => {
            const lr = document.getElementById("statLabelRu").value.trim();
            const la = document.getElementById("statLabelAz").value.trim();
            const vv = document.getElementById("statValue").value.trim();
            if (!lr || !la || !vv) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è KPI");
            try {
              await AboutAPI.createStat({
                labelRu: lr,
                labelAz: la,
                value: vv,
              });
              ["statLabelRu", "statLabelAz", "statValue"].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = "";
              });
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å KPI", error);
            }
          };
        }

        const addVal = document.getElementById("addValue");
        if (addVal) {
          addVal.onclick = async () => {
            const vr = document.getElementById("valRu").value.trim();
            const va = document.getElementById("valAz").value.trim();
            if (!vr || !va) return alert("–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ RU –∏ AZ");
            try {
              await AboutAPI.createValue({ valueRu: vr, valueAz: va });
              ["valRu", "valAz"].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = "";
              });
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ü–µ–Ω–Ω–æ—Å—Ç—å", error);
            }
          };
        }

        const addTl = document.getElementById("addTimeline");
        if (addTl) {
          addTl.onclick = async () => {
            const y = document.getElementById("tlYear").value.trim();
            const tr = document.getElementById("tlTextRu").value.trim();
            const ta = document.getElementById("tlTextAz").value.trim();
            if (!y || !tr || !ta) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≥–æ–¥ –∏ —Ç–µ–∫—Å—Ç—ã RU/AZ");
            try {
              await AboutAPI.createTimeline({
                year: y,
                textRu: tr,
                textAz: ta,
              });
              ["tlYear", "tlTextRu", "tlTextAz"].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = "";
              });
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ", error);
            }
          };
        }

        const addTeam = document.getElementById("addTeam");
        if (addTeam) {
          addTeam.onclick = async () => {
            const name = document.getElementById("teamName").value.trim();
            const rr = document.getElementById("teamRoleRu").value.trim();
            const ra = document.getElementById("teamRoleAz").value.trim();
            const f = document.getElementById("teamAvatar").files?.[0];
            if (!name || !rr || !ra)
              return alert("–ò–º—è –∏ —Ä–æ–ª–∏ RU/AZ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã");
            let dataUrl = "";
            if (f) {
              dataUrl = await readFileAsDataURL(f);
            }
            try {
              await AboutAPI.createTeamMember({
                name,
                roleRu: rr,
                roleAz: ra,
                avatarSrc: dataUrl,
              });
              ["teamName", "teamRoleRu", "teamRoleAz"].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = "";
              });
              const fileEl = document.getElementById("teamAvatar");
              if (fileEl) fileEl.value = "";
              await refreshAllData();
            } catch (error) {
              notifyError("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞", error);
            }
          };
        }
      }

      function renderAboutAdmin() {
        ensureAbout();
        hydrateAboutHero();
        renderAboutStatsAdmin();
        renderAboutValuesAdmin();
        renderAboutTimelineAdmin();
        renderAboutTeamAdmin();
      }

      /* ---------- Init ---------- */
      async function init() {
        bindBrandHero();
        bindFooterActions();
        bindCreateService();
        bindCreateGallery();
        bindCreatePackage();
        bindCreateFaq();
        bindAboutActions();

        renderAllSections();
        await refreshAllData({ silent: true });
      }

      init();
    </script>
  </body>
</html>
